<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Ch·ªânh s·ª≠a Danh m·ª•c</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/Dashboard.css}" />
    <link rel="stylesheet" th:href="@{/css/AddBrands.css}" />
</head>
<body>

<!-- Include Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content">
    <!-- Include Topbar -->
    <div th:replace="~{fragments/topbar :: topbar}"></div>

    <!-- Content Area -->
    <div class="container-fluid px-4 py-4">
        <form id="categoryForm"
              th:action="@{/admin/categories/update/{id}(id=${category.categoryId})}"
              method="POST"
              th:object="${categoryRequest}"
              enctype="multipart/form-data">

            <div class="row g-4">
                <!-- LEFT COLUMN -->
                <div class="col-lg-8">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-info-circle-fill"></i>
                                Th√¥ng tin c∆° b·∫£n
                            </h5>
                        </div>

                        <!-- Error Message -->
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Success Message -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div class="row g-3">
                            <!-- Category Name -->
                            <div class="col-12">
                                <label class="form-label required">T√™n danh m·ª•c</label>
                                <input type="text" class="form-control"
                                       th:field="*{categoryName}"
                                       th:classappend="${#fields.hasErrors('categoryName')} ? 'is-invalid' : ''"
                                       required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('categoryName')}"
                                     th:errors="*{categoryName}"></div>
                                <div class="form-text">T√™n danh m·ª•c n√™n r√µ r√†ng, d·ªÖ hi·ªÉu</div>
                            </div>

                            <!-- Description -->
                            <div class="col-12">
                                <label class="form-label">M√¥ t·∫£</label>
                                <textarea class="form-control"
                                          th:field="*{description}"
                                          rows="4"></textarea>
                                <div class="form-text">M√¥ t·∫£ chi ti·∫øt v·ªÅ danh m·ª•c</div>
                            </div>

                            <!-- Slug -->
                            <div class="col-md-6">
                                <label class="form-label">Slug (URL th√¢n thi·ªán)</label>
                                <input type="text" class="form-control"
                                       th:field="*{slug}">
                                <div class="form-text">URL th√¢n thi·ªán cho SEO</div>
                            </div>

                            <!-- Display Order -->
                            <div class="col-md-6">
                                <label class="form-label">Th·ª© t·ª± hi·ªÉn th·ªã</label>
                                <input type="number" class="form-control"
                                       th:field="*{displayOrder}"
                                       min="0">
                                <div class="form-text">S·ªë th·ª© t·ª± hi·ªÉn th·ªã (c√†ng nh·ªè c√†ng ∆∞u ti√™n)</div>
                            </div>

                            <!-- Parent Category -->
                            <div class="col-12">
                                <label class="form-label">Danh m·ª•c cha</label>
                                <select class="form-select" th:field="*{parentCategory}">
                                    <option value="">-- Kh√¥ng c√≥ (Danh m·ª•c g·ªëc) --</option>

                                    <!-- ROOT CATEGORIES (Level 1) -->
                                    <optgroup label="üìÅ Danh m·ª•c g·ªëc">
                                        <option th:each="cat : ${categories}"
                                                th:if="${cat.parentCategory == null and cat.categoryId != category.categoryId}"
                                                th:value="${cat.categoryId}"
                                                th:text="${cat.categoryName}"
                                                th:selected="${category.parentCategory != null and cat.categoryId == category.parentCategory.categoryId}">
                                            Category Level 1
                                        </option>
                                    </optgroup>

                                    <!-- SUB CATEGORIES (Level 2) -->
                                    <optgroup label="üìÇ Danh m·ª•c con">
                                        <th:block th:each="cat : ${categories}">
                                            <th:block th:if="${cat.parentCategory == null}">
                                                <th:block th:each="subCat : ${cat.subCategories}">
                                                    <option th:if="${subCat.categoryId != category.categoryId}"
                                                            th:value="${subCat. categoryId}"
                                                            th:text="'‚îú‚îÄ ' + ${subCat.categoryName}"
                                                            th:selected="${category.parentCategory != null and subCat.categoryId == category.parentCategory.categoryId}">
                                                        Sub Category Level 2
                                                    </option>
                                                </th:block>
                                            </th:block>
                                        </th:block>
                                    </optgroup>
                                </select>
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i>
                                    Kh√¥ng th·ªÉ ch·ªçn ch√≠nh n√≥ ho·∫∑c danh m·ª•c con c·ªßa n√≥ l√†m cha
                                </div>
                            </div>
                            <!-- Category Image -->
                            <div class="col-12">
                                <label class="form-label">H√¨nh ·∫£nh danh m·ª•c</label>

                                <!-- Hidden field l∆∞u URL ·∫£nh hi·ªán t·∫°i -->
                                <input type="hidden" id="currentImageUrl" th:value="${category.imageUrl}">

                                <div class="image-upload-box" id="imageUploadBox">
                                    <input type="file"
                                           id="categoryImage"
                                           name="defaultImage"
                                           accept="image/*"
                                           hidden>

                                    <!-- Hi·ªÉn th·ªã ·∫£nh c≈© n·∫øu c√≥ -->
                                    <label for="categoryImage" class="image-upload-label"
                                           th:style="${category.imageUrl != null and !category.imageUrl.isEmpty()} ? 'display: none;' : ''">
                                        <i class="bi bi-cloud-upload"></i>
                                        <p>K√©o th·∫£ ho·∫∑c click ƒë·ªÉ ch·ªçn ·∫£nh m·ªõi</p>
                                        <span class="text-muted">PNG, JPG t·ªëi ƒëa 5MB</span>
                                    </label>

                                    <div class="image-preview" id="imagePreview"
                                         th:classappend="${category.imageUrl != null and !category.imageUrl. isEmpty()} ? 'active' : ''">
                                        <img id="previewImg"
                                             th:src="${category.imageUrl != null and !category.imageUrl. isEmpty()} ? ${category.imageUrl} : ''"
                                             alt="Preview">
                                        <div class="preview-actions">
                                            <button type="button" class="btn btn-sm btn-primary" onclick="changeImage()">
                                                <i class="bi bi-arrow-repeat"></i> Thay ƒë·ªïi
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                                <i class="bi bi-trash"></i> X√≥a ·∫£nh
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-warning mt-3" th:if="${category.imageUrl != null and !category.imageUrl. isEmpty()}">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <small>N·∫øu upload ·∫£nh m·ªõi, ·∫£nh c≈© s·∫Ω b·ªã thay th·∫ø</small>
                                </div>

                                <div class="form-text">·∫¢nh ƒë·∫°i di·ªán cho danh m·ª•c (khuy·∫øn ngh·ªã: 500x500px)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN -->
                <div class="col-lg-4">
                    <!-- Status -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-toggle-on"></i>
                                Tr·∫°ng th√°i
                            </h5>
                        </div>
                        <select class="form-select" th:field="*{status}" required>
                            <option th:each="status : ${categoryStatuses}"
                                    th:value="${status.name()}"
                                    th:text="${status.displayName}"
                                    th:selected="${status == category.status}">
                                Status
                            </option>
                        </select>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle"></i>
                            ACTIVE: Hi·ªÉn th·ªã | INACTIVE: ·∫®n
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="form-section">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save"></i> C·∫≠p nh·∫≠t danh m·ª•c
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="bi bi-arrow-counterclockwise"></i> Ho√†n t√°c
                            </button>
                            <a th:href="@{/admin/categories}" class="btn btn-outline-danger">
                                <i class="bi bi-x-circle"></i> H·ªßy
                            </a>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-info-circle-fill"></i>
                                Th√¥ng tin
                            </h5>
                        </div>
                        <div class="stat-item-small">
                            <span class="stat-label-small">ID:</span>
                            <span class="stat-value-small" th:text="${category.categoryId}">-</span>
                        </div>
                        <div class="stat-item-small" th:if="${category.createdAt != null}">
                            <span class="stat-label-small">Ng√†y t·∫°o:</span>
                            <span class="stat-value-small" th:text="${#temporals.format(category.createdAt, 'dd/MM/yyyy HH:mm')}">-</span>
                        </div>
                        <div class="stat-item-small" th:if="${category.updatedAt != null}">
                            <span class="stat-label-small">C·∫≠p nh·∫≠t:</span>
                            <span class="stat-value-small" th:text="${#temporals.format(category.updatedAt, 'dd/MM/yyyy HH:mm')}">-</span>
                        </div>
                    </div>

                    <!-- Tips -->
                    <div class="form-section">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="bi bi-lightbulb-fill"></i> G·ª£i √Ω</h6>
                            <ul class="mb-0 ps-3">
                                <li>Ki·ªÉm tra k·ªπ tr∆∞·ªõc khi l∆∞u</li>
                                <li>Slug s·∫Ω ·∫£nh h∆∞·ªüng ƒë·∫øn SEO</li>
                                <li>Thay ƒë·ªïi danh m·ª•c cha c·∫©n th·∫≠n</li>
                                <li>L∆∞u th∆∞·ªùng xuy√™n ƒë·ªÉ tr√°nh m·∫•t d·ªØ li·ªáu</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="form-section border-danger">
                        <div class="section-header border-danger">
                            <h5 class="section-title text-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                V√πng nguy hi·ªÉm
                            </h5>
                        </div>
                        <p class="small text-muted mb-3">
                            X√≥a danh m·ª•c s·∫Ω x√≥a vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c.
                        </p>
                        <a th:href="@{/admin/categories/delete/{id}(id=${category.categoryId})}"
                           class="btn btn-outline-danger w-100">
                            <i class="bi bi-trash"></i> X√≥a danh m·ª•c
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/javascript/Dashboard.js}"></script>

<script>
    // Store original form data
    let originalFormData = {};

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('categoryForm');
        originalFormData = new FormData(form);
    });

    // Reset form
    function resetForm() {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ho√†n t√°c t·∫•t c·∫£ thay ƒë·ªïi?')) {
            location.reload();
        }
    }

    // Auto generate slug
    document.querySelector('input[name="categoryName"]').addEventListener('input', function(e) {
        const slugInput = document.querySelector('input[name="slug"]');
        if (slugInput. dataset.manualEdit !== 'true') {
            let slug = e.target.value
                .toLowerCase()
                .replace(/ƒë/g, 'd')
                .replace(/[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ]/g, 'a')
                .replace(/[√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ]/g, 'e')
                .replace(/[√¨√≠·ªã·ªâƒ©]/g, 'i')
                .replace(/[√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°]/g, 'o')
                .replace(/[√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ]/g, 'u')
                .replace(/[·ª≥√Ω·ªµ·ª∑·ªπ]/g, 'y')
                .replace(/[^a-z0-9\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-')
                . replace(/-+/g, '-');

            slugInput.value = slug;
        }
    });

    // Mark slug as manually edited
    document.querySelector('input[name="slug"]'). addEventListener('input', function() {
        this.dataset.manualEdit = 'true';
    });

    // Form validation
    document.getElementById('categoryForm').addEventListener('submit', function(e) {
        const categoryName = document.querySelector('input[name="categoryName"]').value. trim();

        if (!categoryName) {
            e.preventDefault();
            alert('Vui l√≤ng nh·∫≠p t√™n danh m·ª•c! ');
            return false;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn. innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang c·∫≠p nh·∫≠t...';
    });

    // Warn before leaving
    let formChanged = false;
    document.getElementById('categoryForm').addEventListener('change', function() {
        formChanged = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    document.getElementById('categoryForm').addEventListener('submit', function() {
        formChanged = false;
    });
    function changeImage() {
        document.getElementById('categoryImage').click();
    }
    document.getElementById('categoryImage').addEventListener('change', function(e) {
        const file = e.target. files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB! ');
                this.value = '';
                return;
            }

            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Ch·ªâ ch·∫•p nh·∫≠n file ·∫£nh (JPG, PNG, GIF)!  ');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.add('active');
                document.querySelector('.image-upload-label').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    function removeImage() {
        document. getElementById('categoryImage').value = '';
        document.getElementById('imagePreview').classList.remove('active');
        document.querySelector('.image-upload-label').style.display = 'block';
    }

    // Drag and drop
    const uploadBox = document.getElementById('imageUploadBox');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadBox.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover']. forEach(eventName => {
        uploadBox.addEventListener(eventName, () => uploadBox.classList.add('drag-over'));
    });

    ['dragleave', 'drop']. forEach(eventName => {
        uploadBox.addEventListener(eventName, () => uploadBox.classList.remove('drag-over'));
    });

    uploadBox.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('categoryImage').files = files;
            document.getElementById('categoryImage').dispatchEvent(new Event('change'));
        }
    });
</script>

</body>
</html>