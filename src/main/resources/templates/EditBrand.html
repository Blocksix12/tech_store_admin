<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chỉnh sửa Thương hiệu - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/Dashboard.css}" />
    <link rel="stylesheet" th:href="@{/css/AddBrands.css}" />
</head>
<body>

<!-- Include Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content">
    <!-- Include Topbar -->
    <div th:replace="~{fragments/topbar :: topbar}"></div>

    <!-- Content Area -->
    <div class="container-fluid px-4 py-4">
        <form id="brandForm" th:action="@{/admin/brands/update/{id}(id=${brand.brandID})}"
              method="POST" th:object="${brandRequest}" enctype="multipart/form-data">
            <div class="row g-4">
                <!-- ========== LEFT COLUMN ========== -->
                <div class="col-lg-8">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-info-circle-fill"></i>
                                Thông tin cơ bản
                            </h5>
                        </div>

                        <!-- Display Error Message -->
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Display Success Message -->
                        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <span th:text="${successMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label required">Tên thương hiệu</label>
                                <input type="text" class="form-control" id="brandName" name="brandName"
                                       th:field="*{brandName}"
                                       th:classappend="${#fields.hasErrors('brandName')} ? 'is-invalid' : ''"
                                       required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('brandName')}" th:errors="*{brandName}"></div>
                                <div class="form-text">Tên thương hiệu nên rõ ràng, dễ nhớ</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" id="description" name="description"
                                          th:field="*{description}" rows="6"
                                          placeholder="Nhập mô tả về thương hiệu... "></textarea>
                                <div class="form-text">Mô tả chi tiết về thương hiệu</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Website</label>
                                <input type="url" class="form-control" id="websiteUrl" name="websiteUrl"
                                       th:field="*{websiteUrl}"
                                       placeholder="https://example.com">
                                <div class="form-text">URL trang web chính thức của thương hiệu</div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Quốc gia</label>
                                <input type="text" class="form-control" id="country" name="country"
                                       th:field="*{country}"
                                       placeholder="Việt Nam">
                                <div class="form-text">Quốc gia xuất xứ của thương hiệu</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Thứ tự hiển thị</label>
                                <input type="number" class="form-control" id="displayOrder" name="displayOrder"
                                       th:field="*{displayOrder}"
                                       min="0" value="0">
                                <div class="form-text">Số thứ tự hiển thị (càng nhỏ càng ưu tiên)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Brand Logo -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-image-fill"></i>
                                Logo thương hiệu
                            </h5>
                        </div>

                        <!-- Hidden field to store current logo URL -->
                        <input type="hidden" id="currentLogoUrl" th:value="${brand.logoUrl}">

                        <div class="image-upload-box" id="imageUploadBox">
                            <input type="file" id="brandLogo" name="defaultImage" accept="image/*" hidden>

                            <!-- Show existing image if available -->
                            <label for="brandLogo" class="image-upload-label"
                                   th:style="${brand.logoUrl != null and ! brand.logoUrl.isEmpty()} ? 'display: none;' : ''">
                                <i class="bi bi-cloud-upload"></i>
                                <p>Kéo thả hoặc click để chọn logo mới</p>
                                <span class="text-muted">PNG, JPG tối đa 5MB</span>
                            </label>

                            <div class="image-preview" id="imagePreview"
                                 th:classappend="${brand.logoUrl != null and !brand.logoUrl. isEmpty()} ? 'active' : ''">
                                <img id="previewImg"
                                     th:src="${brand.logoUrl != null and !brand.logoUrl. isEmpty()} ? ${brand.logoUrl} : ''"
                                     alt="Preview">
                                <div class="preview-actions">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="changeLogo()">
                                        <i class="bi bi-arrow-repeat"></i> Thay đổi
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                        <i class="bi bi-trash"></i> Xóa ảnh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3" th:if="${brand.logoUrl != null and !brand.logoUrl. isEmpty()}">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>Nếu bạn upload logo mới, logo cũ sẽ bị thay thế</small>
                        </div>
                    </div>
                </div>

                <!-- ========== RIGHT COLUMN ========== -->
                <div class="col-lg-4">
                    <!-- Status -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-toggle-on"></i>
                                Trạng thái
                            </h5>
                        </div>
                        <select class="form-select" id="status" name="status" th:field="*{status}" required>
                            <option th:each="status : ${brandStatuses}"
                                    th:value="${status}"
                                    th:text="${status. name()}"
                                    th:selected="${status == brandRequest.status}">Status</option>
                        </select>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle"></i>
                            ACTIVE: Hiển thị | INACTIVE: Ẩn
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="form-section">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-save"></i> Cập nhật thương hiệu
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                <i class="bi bi-arrow-counterclockwise"></i> Hoàn tác
                            </button>
                            <a th:href="@{/admin/brands}" class="btn btn-outline-danger">
                                <i class="bi bi-x-circle"></i> Hủy
                            </a>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <h5 class="section-title">
                                <i class="bi bi-info-circle-fill"></i>
                                Thông tin
                            </h5>
                        </div>
                        <div class="stat-item-small">
                            <span class="stat-label-small">ID:</span>
                            <span class="stat-value-small" th:text="${brand.brandID}">-</span>
                        </div>
                        <div class="stat-item-small" th:if="${brand.createdAt != null}">
                            <span class="stat-label-small">Ngày tạo:</span>
                            <span class="stat-value-small" th:text="${#dates.format(brand.createdAt, 'dd/MM/yyyy HH:mm')}">-</span>
                        </div>
                        <div class="stat-item-small" th:if="${brand.lastModifiedAt != null}">
                            <span class="stat-label-small">Cập nhật:</span>
                            <span class="stat-value-small" th:text="${#dates.format(brand.lastModifiedAt, 'dd/MM/yyyy HH:mm')}">-</span>
                        </div>
                    </div>

                    <!-- Quick Tips -->
                    <div class="form-section">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="bi bi-lightbulb-fill"></i> Gợi ý</h6>
                            <ul class="mb-0 ps-3">
                                <li>Logo nên có nền trong suốt</li>
                                <li>Kích thước khuyến nghị: 200x200px</li>
                                <li>Định dạng PNG cho chất lượng tốt nhất</li>
                                <li>Kiểm tra kỹ trước khi lưu</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="form-section border-danger">
                        <div class="section-header border-danger">
                            <h5 class="section-title text-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                Vùng nguy hiểm
                            </h5>
                        </div>
                        <p class="small text-muted mb-3">
                            Xóa thương hiệu sẽ ẩn nó khỏi danh sách hiển thị nhưng không xóa dữ liệu.
                        </p>
                        <form th:action="@{/admin/brands/delete/{id}(id=${brand.brandID})}"
                              method="post"
                              onsubmit="return confirm('Bạn có chắc chắn muốn vô hiệu hóa thương hiệu này?');">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-trash"></i> Vô hiệu hóa thương hiệu
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/javascript/Dashboard.js}"></script>
<script>
    // Store original form data
    let originalFormData = {};

    document.addEventListener('DOMContentLoaded', function() {
        // Save original form data
        const form = document.getElementById('brandForm');
        originalFormData = new FormData(form);
    });

    // Image upload preview
    document.getElementById('brandLogo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('Kích thước ảnh không được vượt quá 5MB! ');
                this.value = '';
                return;
            }

            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Chỉ chấp nhận file ảnh (JPG, PNG, GIF)! ');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.add('active');
                document.querySelector('.image-upload-label').style.display = 'none';
            };
            reader. readAsDataURL(file);
        }
    });

    function changeLogo() {
        document.getElementById('brandLogo').click();
    }

    function removeImage() {
        if (confirm('Bạn có chắc muốn xóa logo này? ')) {
            document.getElementById('brandLogo').value = '';
            document.getElementById('imagePreview').classList.remove('active');
            document.querySelector('.image-upload-label').style.display = 'block';

            // Clear preview image
            document.getElementById('previewImg').src = '';
        }
    }

    // Drag and drop
    const uploadBox = document.getElementById('imageUploadBox');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadBox.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    ['dragenter', 'dragover']. forEach(eventName => {
        uploadBox.addEventListener(eventName, () => uploadBox.classList.add('drag-over'));
    });

    ['dragleave', 'drop']. forEach(eventName => {
        uploadBox.addEventListener(eventName, () => uploadBox.classList.remove('drag-over'));
    });

    uploadBox.addEventListener('drop', function(e) {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            document.getElementById('brandLogo').files = files;
            document.getElementById('brandLogo').dispatchEvent(new Event('change'));
        }
    });

    // Form validation
    document.getElementById('brandForm').addEventListener('submit', function(e) {
        const brandName = document.getElementById('brandName').value.trim();
        if (!brandName) {
            e.preventDefault();
            alert('Vui lòng nhập tên thương hiệu!');
            document.getElementById('brandName').focus();
            return false;
        }

        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn. innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...';
    });

    // Reset form to original values
    function resetForm() {
        if (confirm('Bạn có chắc muốn hoàn tác tất cả thay đổi?')) {
            location.reload();
        }
    }

    // Auto-trim on blur
    document.getElementById('brandName').addEventListener('blur', function() {
        this.value = this. value.trim();
    });

    // Warn before leaving if form is dirty
    let formChanged = false;
    document.getElementById('brandForm').addEventListener('change', function() {
        formChanged = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (formChanged) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Don't warn when submitting
    document.getElementById('brandForm').addEventListener('submit', function() {
        formChanged = false;
    });
</script>

</body>
</html>