<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sửa Sản phẩm - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/Dashboard.css}" />
    <link rel="stylesheet" th:href="@{/css/AddProduct.css}" />
</head>
<body>

<!-- Include Sidebar -->
<div th:replace="~{fragments/sidebar :: sidebar}"></div>

<!-- Main Content -->
<div class="main-content">
    <!-- Include Topbar -->
    <div th:replace="~{fragments/topbar :: topbar}"></div>

<!--    &lt;!&ndash; Page Header &ndash;&gt;-->
<!--    <div class="container-fluid px-0">-->
<!--        <div class="page-header-edit mb-4">-->
<!--            <div>-->
<!--                <h2 class="page-title-edit mb-2">-->
<!--                    <i class="bi bi-pencil-square me-2"></i>-->
<!--                    Sửa Sản phẩm-->
<!--                </h2>-->
<!--                <p class="page-subtitle-edit mb-0">Cập nhật thông tin sản phẩm</p>-->
<!--            </div>-->
<!--            <a th:href="@{/admin/products}" class="btn btn-back-edit">-->
<!--                <i class="bi bi-arrow-left me-2"></i> Quay lại-->
<!--            </a>-->
<!--        </div>-->
<!--    </div>-->

    <style>
        .page-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
            color: white;
            margin-bottom: 2rem;
        }

        .page-header-modern .breadcrumb {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .page-header-modern .breadcrumb-item a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
        }

        .page-header-modern .breadcrumb-item a:hover {
            color: white;
        }

        .page-header-modern .breadcrumb-item.active {
            color: rgba(255, 255, 255, 0.7);
        }

        .page-header-modern .breadcrumb-item + .breadcrumb-item::before {
            color: rgba(255, 255, 255, 0.5);
        }

        .page-header-modern .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-header-modern .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .page-header-modern .btn-outline-secondary {
            background: white;
            color: #667eea;
            border: none;
            font-weight: 600;
            padding: 0.625rem 1.5rem;
        }

        .page-header-modern .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>

    <style>
        /* Page Header Styling - Match form padding */
        .page-header-edit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .page-title-edit {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
            display: flex;
            align-items: center;
            letter-spacing: -0.02em;
        }

        .page-title-edit i {
            font-size: 1.5rem;
            color: #667eea;
        }

        .page-subtitle-edit {
            color: #718096;
            font-size: 0.95rem;
            font-weight: 400;
            margin-top: 0.5rem;
            padding-left: 2.25rem;
        }

        .btn-back-edit {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.65rem 1.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .btn-back-edit:hover {
            background: #5568d3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-back-edit i {
            font-size: 1rem;
        }

        /* Form spacing consistency */
        .row.g-3 {
            --bs-gutter-y: 1rem;
            --bs-gutter-x: 1rem;
        }
    </style>

    <!-- Alert Messages -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Content Area -->
    <form id="productForm" th:action="@{/admin/products/update/{id}(id=${product.id})}" method="POST" th:object="${product}" enctype="multipart/form-data">
        <div class="row g-4">
            <!-- Left Column - Main Info -->
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="form-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-info-circle-fill"></i>
                            Thông tin cơ bản
                        </h5>
                    </div>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label required">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="productName" name="name" th:field="*{name}" required>
                            <div class="form-text">Tên sản phẩm nên rõ ràng, dễ hiểu</div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                        </div>

                        <div class="col-12">
                            <label class="form-label required">Slug (URL)</label>
                            <input type="text" class="form-control" id="productSlug" name="slug" th:field="*{slug}" required>
                            <div class="form-text">URL thân thiện cho sản phẩm (tự động tạo từ tên)</div>
                            <div class="invalid-feedback" th:if="${#fields.hasErrors('slug')}" th:errors="*{slug}"></div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Mô tả sản phẩm</label>
                            <textarea class="form-control" id="description" name="description" th:field="*{description}" rows="6"></textarea>
                            <div class="form-text">Mô tả chi tiết về sản phẩm</div>
                        </div>
                    </div>
                </div>

                <!-- Product Image -->
                <div class="form-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-image-fill"></i>
                            Hình ảnh sản phẩm
                        </h5>
                    </div>

                    <!-- Current Image -->
                    <div class="mb-3" th:if="${product.imageUrl}">
                        <label class="form-label">Ảnh hiện tại:</label>
                        <div class="current-image-wrapper">
                            <img th:src="@{${product.imageUrl}}" alt="Current Product" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>

                    <div class="image-upload-box" id="imageUploadBox">
                        <input type="file" id="productImage" name="defaultImage" accept="image/*" hidden>
                        <label for="productImage" class="image-upload-label">
                            <i class="bi bi-cloud-upload"></i>
                            <p>Kéo thả hoặc click để thay đổi ảnh</p>
                            <span class="text-muted">PNG, JPG tối đa 5MB (Để trống nếu không muốn thay đổi)</span>
                        </label>
                        <div class="image-preview" id="imagePreview">
                            <img id="previewImg" src="" alt="Preview">
                            <div class="preview-actions">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                    <i class="bi bi-trash"></i> Xóa ảnh mới
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Additional Info -->
            <div class="col-lg-4">
                <!-- Status -->
                <div class="form-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-toggle-on"></i>
                            Trạng thái
                        </h5>
                    </div>
                    <select class="form-select" id="status" name="status" th:field="*{status}" required>
                        <option value="DRAFT">Nháp</option>
                        <option value="PUBLISHED">Xuất bản</option>
                        <option value="ARCHIVED">Lưu trữ</option>
                    </select>
                </div>

                <!-- Category -->
                <div class="form-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-folder-fill"></i>
                            Danh mục
                        </h5>
                    </div>
                    <select class="form-select" id="categoryId" name="categoryId" th:field="*{categoryId}" required>
                        <option value="">Chọn danh mục</option>
                        <option th:each="category : ${categories}"
                                th:value="${category.categoryId}"
                                th:text="${category.categoryName}"
                                th:selected="${category.categoryId == product.categoryId}">Category</option>
                    </select>
                </div>

                <!-- Brand -->
                <div class="form-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-award-fill"></i>
                            Thương hiệu
                        </h5>
                    </div>
                    <select class="form-select" id="brandId" name="brandId" th:field="*{brandId}" required>
                        <option value="">Chọn thương hiệu</option>
                        <option th:each="brand : ${brands}"
                                th:value="${brand.brandID}"
                                th:text="${brand.brandName}"
                                th:selected="${brand.brandID == product.brandId}">Brand</option>
                    </select>
                </div>

                <!-- Actions -->
                <div class="form-section">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-check-circle"></i> Cập nhật sản phẩm
                        </button>
                        <a th:href="@{/admin/products}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Hủy
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                            <i class="bi bi-trash"></i> Xóa sản phẩm
                        </button>
                    </div>
                </div>

                <!-- Info -->
                <div class="form-section">
                    <div class="section-header">
                        <h5 class="section-title">
                            <i class="bi bi-info-circle-fill"></i>
                            Thông tin
                        </h5>
                    </div>
                    <div class="stat-item-small">
                        <span class="stat-label-small">Mã sản phẩm:</span>
                        <span class="stat-value-small" th:text="${product.id}">ID</span>
                    </div>
                    <div class="stat-item-small" th:if="${createdAt}">
                        <span class="stat-label-small">Ngày tạo:</span>
                        <span class="stat-value-small" th:text="${#dates.format(createdAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                    </div>
                    <div class="stat-item-small" th:if="${updatedAt}">
                        <span class="stat-label-small">Cập nhật lần cuối:</span>
                        <span class="stat-value-small" th:text="${#dates.format(updatedAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Xác nhận xóa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Bạn có chắc chắn muốn xóa sản phẩm này?</p>
                <p class="text-danger mb-0 mt-2"><strong>Hành động này không thể hoàn tác!</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <form th:action="@{/admin/products/delete/{id}(id=${product.id})}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Xóa
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Auto-generate slug from product name
    document.getElementById('productName').addEventListener('input', function(e) {
        const name = e.target.value;
        const slug = name.toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/đ/g, 'd')
            .replace(/Đ/g, 'D')
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .trim();
        document.getElementById('productSlug').value = slug;
    });

    // Image upload preview
    document.getElementById('productImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Kích thước ảnh không được vượt quá 5MB!');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').classList.add('active');
                document.querySelector('.image-upload-label').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    });

    function removeImage() {
        document.getElementById('productImage').value = '';
        document.getElementById('imagePreview').classList.remove('active');
        document.querySelector('.image-upload-label').style.display = 'block';
    }

    // Form validation before submission
    document.getElementById('productForm').addEventListener('submit', function(e) {
        const categoryId = document.getElementById('categoryId').value;
        const brandId = document.getElementById('brandId').value;

        if (!categoryId) {
            e.preventDefault();
            alert('Vui lòng chọn danh mục sản phẩm!');
            return false;
        }

        if (!brandId) {
            e.preventDefault();
            alert('Vui lòng chọn thương hiệu!');
            return false;
        }

        // Show loading indicator
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...';
    });

    function confirmDelete() {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    // Auto-dismiss alerts after 5 seconds
    setTimeout(function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
</script>
<script th:src="@{/javascript/AddProduct.js}"></script>
<script th:src="@{/javascript/Dashboard.js}"></script>

</body>
</html>