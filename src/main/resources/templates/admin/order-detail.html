<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Chi tiết đơn hàng</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin-order.css}">
</head>
<body>

<!-- Sidebar (giống trang list) -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-brand">
        <i class="bi bi-shop-window"></i>
        <span class="sidebar-brand-text">Tech Store</span>
    </div>
    <div class="sidebar-menu">
        <div class="menu-section-title">Main</div>
        <a th:href="@{/admin/dashboard}" class="menu-item">
            <i class="bi bi-grid-fill"></i>
            <span>Dashboard</span>
        </a>
        <div class="menu-section-title">Quản lý</div>
        <div>
            <div class="menu-item active expanded" onclick="toggleSubmenu(this)">
                <i class="bi bi-cart-check-fill"></i>
                <span>Đơn hàng</span>
                <i class="bi bi-chevron-down"></i>
            </div>
            <div class="submenu show">
                <a th:href="@{/admin/quanlidonhang}" class="submenu-item active">Danh sách đơn hàng</a>
            </div>
        </div>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <i class="bi bi-list"></i>
            </button>
            <div>
                <h1 class="page-title" th:text="'Chi tiết đơn hàng #' + ${order.orderNo}">Chi tiết đơn hàng</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Trang chủ</a></li>
                        <li class="breadcrumb-item"><a th:href="@{/admin/quanlidonhang}">Đơn hàng</a></li>
                        <li class="breadcrumb-item active">Chi tiết</li>
                    </ol>
                </nav>
            </div>
        </div>
        <div class="topbar-right">
            <div class="user-menu">
                <div class="user-avatar">A</div>
                <div class="user-info">
                    <div class="user-name">Admin User</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Action Buttons -->
        <button class="btn btn-primary"
                th:data-order-id="${order.orderID}"
                onclick="updateStatus(this.dataset.orderId)">
            <i class="bi bi-pencil"></i> Cập nhật trạng thái
        </button>

        <button class="btn btn-info text-white"
                th:data-order-id="${order.orderID}"
                onclick="exportOrderPdf(this.dataset.orderId)">
            <i class="bi bi-file-earmark-pdf"></i> Xuất PDF
        </button>

        <button class="btn btn-danger"
                th:data-order-id="${order.orderID}"
                onclick="deleteOrder(this.dataset.orderId)">
            <i class="bi bi-trash"></i> Xóa đơn hàng
        </button>

        <div class="row g-4">
            <!-- Order Info Card -->
            <div class="col-lg-8">
                <div class="custom-table">
                    <div class="table-header">
                        <h5 class="table-title">
                            <i class="bi bi-info-circle"></i> Thông tin đơn hàng
                        </h5>
                        <th:block th:switch="${order.status.name()}">
                            <span class="status-badge pending" th:case="'PENDING'">Chờ xử lý</span>
                            <span class="status-badge processing" th:case="'PROCESSING'">Đang xử lý</span>
                            <span class="status-badge shipped" th:case="'SHIPPED'">Đang giao</span>
                            <span class="status-badge delivered" th:case="'DELIVERED'">Hoàn tất</span>
                            <span class="status-badge cancelled" th:case="*">Đã hủy</span>
                        </th:block>
                    </div>
                    <div class="p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Mã đơn hàng</label>
                                    <div class="fw-bold fs-5" th:text="${order.orderNo}">ORD-2024-001</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Ngày đặt hàng</label>
                                    <div class="fw-bold"
                                         th:text="${#temporals.format(order.createdAt.toLocalDateTime(), 'dd/MM/yyyy HH:mm')}">
                                        17/11/2024 10:30
                                    </div>                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Phương thức thanh toán</label>
                                    <div>
                                        <th:block th:switch="${order.paymentMethod.name()}">
                                            <span class="badge bg-primary" th:case="'MOMO'">MOMO</span>
                                            <span class="badge bg-info" th:case="'VNPAY'">VNPAY</span>
                                            <span class="badge bg-warning" th:case="'STRIPE'">STRIPE</span>
                                            <span class="badge bg-secondary" th:case="*">COD</span>
                                        </th:block>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="text-muted small">Tổng tiền</label>
                                    <div class="fw-bold text-primary fs-4" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '₫'">15,000,000₫</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="custom-table mt-4">
                    <div class="table-header">
                        <h5 class="table-title">
                            <i class="bi bi-box-seam"></i> Sản phẩm (<span th:text="${totalItems}">0</span> sản phẩm)
                        </h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                            <tr>
                                <th>Sản phẩm</th>
                                <th>Màu sắc</th>
                                <th>Màn hình</th>
                                <th>Bộ nhớ</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${orderItems}">
                                <td>
                                    <div class="fw-bold">Sản phẩm</div>
                                    <small class="text-muted">SKU: <span th:text="${item.orderItemID}">ID</span></small>
                                </td>
                                <td th:text="${item.color != null ? item.color.colorname : '-'}">Black</td>
                                <td th:text="${item.color != null ? item.color.colorName : '-'}">Black</td>
                                <td th:text="${item.storage != null ? item.storage.ram + '/' + item.storage.rom : '-'}">8GB/256GB</td>
                                <td th:text="${item.quantity}">1</td>
                                <td th:text="${#numbers.formatDecimal(item.subTotal / item.quantity, 0, 'COMMA', 0, 'POINT')} + '₫'">15,000,000₫</td>
                                <td class="fw-bold" th:text="${#numbers.formatDecimal(item.subTotal, 0, 'COMMA', 0, 'POINT')} + '₫'">15,000,000₫</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customer & Shipping Info -->
            <div class="col-lg-4">
                <!-- Customer Info -->
                <div class="custom-table mb-4">
                    <div class="table-header">
                        <h5 class="table-title">
                            <i class="bi bi-person"></i> Thông tin khách hàng
                        </h5>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <label class="text-muted small">Họ tên</label>
                            <div class="fw-bold" th:text="${order.user != null ? order.user.fullName : 'Khách lẻ'}">Nguyễn Văn A</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Email</label>
                            <div th:text="${order.user != null ? order.user.email : '-'}">nguyenvana@email.com</div>
                        </div>
                        <div class="mb-3">
                            <label class="text-muted small">Số điện thoại</label>
                            <div th:text="${order.user != null ? order.user.phone : '-'}">0901234567</div>
                        </div>
                    </div>
                </div>

                <!-- Shipping Info -->
                <div class="custom-table">
                    <div class="table-header">
                        <h5 class="table-title">
                            <i class="bi bi-truck"></i> Thông tin giao hàng
                        </h5>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <label class="text-muted small">Mã vận chuyển</label>
                            <div class="fw-bold" th:text="${order.shipping}">SHIP-001</div>
                        </div>
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            <small>Thông tin chi tiết vận chuyển sẽ được cập nhật sau</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal cập nhật trạng thái -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square text-primary"></i> Cập nhật trạng thái
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="orderIdInput" th:value="${order.orderID}">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Trạng thái mới</label>
                        <select class="form-select" id="newStatusSelect" required>
                            <option value="">-- Chọn trạng thái --</option>
                            <option value="PENDING">Chờ xử lý</option>
                            <option value="PROCESSING">Đang xử lý</option>
                            <option value="SHIPPED">Đang giao</option>
                            <option value="DELIVERED">Hoàn tất</option>
                            <option value="CANCELLED">Đã hủy</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin-order.js}"></script>
</body>
</html>